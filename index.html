<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Progresso — Español Avanzado (RPG)</title>
  <meta name="theme-color" content="#0f172a">
  <style>
    :root{
      --bg:#0b1220;/* slate-950 */
      --card:#101b34;/* slate-900 */
      --muted:#9fb0d0;
      --text:#e6edf7;
      --accent:#6ee7b7;/* emerald-300 */
      --accent-2:#60a5fa;/* blue-400 */
      --warn:#f59e0b;/* amber-500 */
      --danger:#ef4444;/* red-500 */
      --ok:#22c55e;/* green-500 */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
      background: radial-gradient(1200px 600px at 10% 0%, #0f1a33 0%, var(--bg) 45%),
                  radial-gradient(900px 500px at 100% 0%, #0c1530 0%, transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    header{padding:28px 20px 6px; display:flex; align-items:center; gap:14px; flex-wrap:wrap}
    .logo{height:44px; width:44px; border-radius:12px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); display:grid; place-items:center; color:#0b1220; font-weight:900; box-shadow: var(--shadow);}
    h1{font-size: clamp(18px, 2.4vw, 26px); margin:0}
    .sub{color:var(--muted); font-size:14px}

    main{padding:16px; max-width:1200px; margin:0 auto}
    .grid{display:grid; gap:16px}
    @media(min-width:1100px){ .grid{ grid-template-columns: 1.2fr .8fr } }

    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)}

    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .pill{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); color:var(--muted); font-size:12px}

    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px}
    .kpi{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px}
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .value{font-size:22px; font-weight:700}

    .progress{height:12px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; position:relative}
    .progress>span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); transition:width .5s ease}
    .progress .pct{position:absolute; inset:0; display:grid; place-items:center; font-size:11px; color:#001; mix-blend-mode:screen; font-weight:700}

    form{display:grid; gap:10px; margin-top:8px}
    .grid2{display:grid; gap:10px}
    @media(min-width:680px){ .grid2{grid-template-columns: 1fr 1fr 1fr} }
    input, select, textarea, button{width:100%; padding:10px 12px; border-radius:12px; background:#0d1830; border:1px solid rgba(255,255,255,.08); color:var(--text);}    
    textarea{min-height:80px; resize:vertical}
    button{cursor:pointer; font-weight:700; letter-spacing:.2px}
    .primary{background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#0b1220; border:none}
    .ghost{background:transparent; border:1px dashed rgba(255,255,255,.2); color:var(--muted)}

    table{width:100%; border-collapse: collapse; margin-top:12px; font-size:14px}
    th, td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.06)}
    th{color:var(--muted); text-align:left; font-weight:600}
    tbody tr:hover{background: rgba(255,255,255,.03)}

    .badges{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .badge{display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08)}
    .badge .name{font-weight:700}
    .badge .desc{color:var(--muted); font-size:12px}

    .weeks{display:grid; gap:10px; margin-top:10px}
    .week{display:flex; align-items:center; gap:10px}
    .week .bar{flex:1; height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
    .week .bar>span{display:block; height:100%; background:linear-gradient(90deg, var(--warn), var(--ok)); width:0%; transition:width .5s}

    .missions{display:grid; gap:10px}
    .mission{display:flex; gap:12px; align-items:center; padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:14px; background:rgba(255,255,255,.04)}
    .mission .when{min-width:86px}
    .mission .title{font-weight:700}
    .mission .meta{color:var(--muted); font-size:12px}

    /* Estilização do checklist no modal (aproxima do exemplo) */
    #stepsWrap label{display:flex; align-items:center; justify-content:space-between; gap:12px; margin:0; padding:14px; border-radius:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10)}
    #stepsWrap label + label{margin-top:12px}
    #stepsWrap label span{font-weight:600}
    #stepsWrap label::after{content:''; min-width:68px; height:0}
    /* Ensure the "Feito" pill centers text within the blue background */
    #stepsWrap label:has(input:checked)::after{
      content:'Feito';
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px; background:var(--accent-2);
      color:#0b1220; font-weight:700; font-size:12px; text-align:center;
      line-height:1; height:auto; /* override placeholder height to avoid misalignment */
    }
    #saveSession{background:linear-gradient(90deg, var(--ok), #16a34a); color:#0b1220; border:none}
    #finishMission{background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#0b1220; border:none}

    /* Checklist modal styles */
    .checklist{display:grid; gap:12px; margin:12px 0}
    .check-item{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px; border-radius:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10)}
    .check-left{display:flex; align-items:center; gap:12px}
    .check-label{font-weight:600}
    .done-badge{padding:6px 10px; border-radius:999px; background:var(--accent-2); color:#0b1220; font-weight:700; font-size:12px; min-width:68px; text-align:center}
    .done-placeholder{min-width:68px}
    .btn-success{background:linear-gradient(90deg, var(--ok), #16a34a); color:#0b1220; border:none}
    .btn-finish{background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#0b1220; border:none}
    .modal-sub{color:var(--muted); margin:4px 0 8px}
  
    footer{padding:30px 16px 60px; color:var(--muted); text-align:center}
    a.link{color:var(--accent)}

    /* Small close button in top-right of modal */
    .modal-card{ position:relative }
    .modal-card .close-btn{
      position:absolute; top:50%; right:12px; transform:translateY(-50%); z-index:2;
      width:36px; height:36px; padding:0;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px; border:1px solid rgba(255,255,255,.20);
      background:rgba(255,255,255,.12); color:var(--text);
      font-weight:800; font-size:20px; line-height:1; cursor:pointer;
    }
    .modal-card .close-btn:hover{ background:rgba(255,255,255,.18) }
    .modal-card h3{ padding-right:56px }

    /* Modal actions responsive layout */
    #modalBody > .row{ display:grid !important; grid-template-columns: 1fr; gap:10px; justify-content:stretch !important }
    @media(min-width:560px){ #modalBody > .row{ grid-template-columns: 1fr 1fr } }
    #modalBody > .row > button{ width:100%; padding:12px 14px; font-weight:800 }
    #modalBody #saveSession{ background:linear-gradient(90deg, var(--ok), #16a34a); color:#0b1220; border:none }
    #modalBody #finishMission{ background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#0b1220; border:none }
    /* Checklist labels wrap and align nicely */
    #stepsWrap label{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:0; padding:12px; border-radius:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10) }
    #stepsWrap label + label{ margin-top:10px }
    #stepsWrap label span{ font-weight:600; white-space:normal; line-height:1.4 }
    #stepsWrap input[type="checkbox"]{ width:18px; height:18px }
  </style>
</head>
<body>
  <header>
    <div class="logo">XP</div>
    <div>
      <h1>RPG do Español Avanzado — Painel de Progresso</h1>
      <div class="sub">Níveis • XP • Medalhas • Missões diárias • Offline-first</div>
    </div>
    <div style="margin-left:auto" class="row">
      <span class="pill" id="levelLabel">Nível 1 — Exploradora del idioma</span>
      <span class="pill" id="monthLabel"></span>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h2 style="margin:0 0 6px 0">Progresso do mês</h2>
          <div class="sub">Meta mensal: <b>100 XP</b></div>
        </div>
        <div class="kpis">
          <div class="kpi"><div class="label">XP do mês</div><div class="value" id="xpMonth">0</div></div>
          <div class="kpi"><div class="label">Progresso</div><div class="value" id="pctMonth">0%</div></div>
          <div class="kpi"><div class="label">Streak diário</div><div class="value" id="streakDay">0</div></div>
          <div class="kpi"><div class="label">Medalhas</div><div class="value" id="countBadges">0</div></div>
        </div>
      </div>
      <div class="progress" style="margin-top:12px">
        <span id="barMonth"></span>
        <div class="pct" id="barPct">0%</div>
      </div>
      <div class="weeks" id="weeks"></div>

      <h3 style="margin:12px 0 6px">Missão de hoje</h3>
      <div class="missions" id="todayMissions"></div>

      <h4 style="margin:14px 0 6px">Próximas missões</h4>
      <div class="missions" id="nextMissions"></div>
    </section>

    <aside class="card">
      <h3 style="margin-top:0">Nova atividade</h3>
      <form id="activityForm">
        <div class="grid2">
          <div>
            <label for="date">Data</label>
            <input id="date" type="date" required />
          </div>
          <div>
            <label for="type">Tipo</label>
            <select id="type" required>
              <option value="movie">🎬 Filme/Série (≥30min) — 10 XP</option>
              <option value="podcast">🎧 Podcast curto (10–15min) — 5 XP</option>
              <option value="speaking">🗣️ Prática de fala (Aula Seg/Qua) — 15 XP</option>
              <option value="writing">✍️ Mini escrita (5–10 linhas) — 5 XP</option>
              <option value="vocab">📚 Conjugação/Vocabulário — 5 XP</option>
              <option value="record">🪞 Gravação + autoavaliação — 10 XP</option>
              <option value="custom">✨ Custom (definir XP)</option>
            </select>
          </div>
          <div>
            <label for="minutes">Minutos (opcional)</label>
            <input id="minutes" type="number" min="0" placeholder="ex: 30" />
          </div>
        </div>
        <div>
          <label for="notes">Notas (opcional)</label>
          <textarea id="notes" placeholder="O que você praticou? Link? Tema?"></textarea>
        </div>
        <div class="grid2">
          <div>
            <label for="xp">XP</label>
            <input id="xp" type="number" min="0" step="1" required />
          </div>
          <button class="primary" type="submit">Adicionar atividade</button>
          <button type="button" class="ghost" id="resetMonthBtn">Zerar mês atual</button>
        </div>
      </form>
      <div class="row" style="margin-top:10px">
        <button class="ghost" id="exportBtn">Exportar JSON</button>
        <button class="ghost" id="importBtn">Importar JSON</button>
        <button class="ghost" id="resetAllBtn" title="Apaga atividades, sessões e currículo">Resetar tudo (TESTE)</button>
      </div>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </aside>

    <section class="card" style="grid-column: 1 / -1;">
      <h3 style="margin-top:0">Atividades do mês</h3>
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Tipo</th>
            <th>XP</th>
            <th>Min</th>
            <th>Notas</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
      <h3 style="margin-top:0">Medalhas</h3>
      <div class="badges" id="badges"></div>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
      <h3 style="margin-top:0">Currículo da Jornada (visão geral)</h3>
      <div class="sub">Fases até o nível avançado — conteúdos futuros ficam <b>bloqueados</b> e aparecem como missão no dia certo.</div>
      <div class="missions" id="curriculum"></div>
    </section>
  </main>

  <footer>
    Feito com ♥ para a Bruna — modo profe 🎓 |
    <a class="link" href="#" id="installBtn">Instalar (PWA)</a>
    &nbsp;•&nbsp;
    <a class="link" href="#" id="refreshBtn" title="Limpa cache e recarrega">Atualizar app / limpar cache</a>
  </footer>

<script>
(function(){
  const STORAGE_KEY = 'es_rpg_progress_v5';
  const state = load();
  if(!state.sessions) state.sessions = {}; // sessions by missionId

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const TYPES = {
    movie:   {label:'Filme/Série', xp:10, emoji:'🎬'},
    podcast: {label:'Podcast curto', xp:5, emoji:'🎧'},
    speaking:{label:'Prática de fala (Aula Seg/Qua)', xp:15, emoji:'🗣️'},
    writing: {label:'Mini escrita', xp:5, emoji:'✍️'},
    vocab:   {label:'Conjugação/Vocabulário', xp:5, emoji:'📚'},
    record:  {label:'Gravação + autoavaliação', xp:10, emoji:'🪞'},
    custom:  {label:'Custom', xp:0, emoji:'✨'},
  };

  const MEDALS = [
    {id:'FIRST_MOVIE',  name:'Primera película en español', emoji:'🥇', cond:(acts)=>acts.some(a=>a.type==='movie') , desc:'Primeiro filme/série em espanhol concluído.'},
    {id:'FIRST_SPEAK',  name:'Primera práctica de habla',   emoji:'🗣️', cond:(acts)=>acts.some(a=>a.type==='speaking'), desc:'Primeira sessão de fala guiada.'},
    {id:'PODCAST_START',name:'Oídos en marcha',             emoji:'🎧', cond:(acts)=>acts.some(a=>a.type==='podcast'), desc:'Primeiro podcast curto concluído.'},
    {id:'WEEK_STREAK',  name:'Semana consistente',          emoji:'🔥', cond:weekStreak, desc:'3 ou mais dias ativos em uma semana.'},
    {id:'MONTH_100',    name:'Meta do mês alcançada',       emoji:'🏆', cond:(acts)=>sumXP(acts)>=100, desc:'100 XP ou mais no mês.'},
  ];

  // Build curriculum if missing, using startDate (default = today)
  if(!state.curriculum){ state.curriculum = buildCurriculumFrom(state.startDate || todayStr()); save(); }

  initFormDefaults();
  ensureStartElements();
  renderAll();
  attachEvents();
  registerPWA();
  startDateWatcher();

  function load(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { activities: [], curriculum:null, startDate:null }; }
    catch(e){ return { activities: [], curriculum:null, startDate:null } }
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  function ensureStartElements(){
    try{
      if(!document.querySelector('#startLabel')){
        const s = document.createElement('span'); s.id='startLabel'; s.style.display='none'; document.body.appendChild(s);
      }
      if(!document.querySelector('#startDate')){
        const i = document.createElement('input'); i.id='startDate'; i.type='date'; i.style.display='none'; document.body.appendChild(i);
      }
    }catch(e){ /* no-op */ }
  }

  function todayStr(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const d2 = new Date(d.getTime() - off*60000);
    return d2.toISOString().slice(0,10);
  }
  function monthKey(d){ const z = new Date(d); return z.getFullYear()+'-'+String(z.getMonth()+1).padStart(2,'0'); }
  function currentMonthKey(){ return monthKey(new Date()); }

  function initFormDefaults(){
    $('#date').value = todayStr();
    const typeSel = $('#type');
    const xpInput = $('#xp');
    const setXP = ()=>{ const t = TYPES[typeSel.value]; xpInput.value = t ? t.xp : 0; };
    setXP(); typeSel.addEventListener('change', setXP);
  }

  function attachEvents(){
    $('#activityForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const date = $('#date').value;
      const type = $('#type').value;
      const minutes = Number($('#minutes').value || 0);
      const xp = Math.max(0, Math.floor(Number($('#xp').value || 0)));
      const notes = $('#notes').value.trim();
      if(!date || !type || isNaN(xp)) return;
      state.activities.push({ id: uid(), date, type, minutes, xp, notes });
      save(); e.target.reset(); initFormDefaults(); renderAll();
    });

    $('#resetMonthBtn').addEventListener('click', ()=>{
      if(!confirm('Zerar todas as atividades deste mês?')) return;
      const mk = currentMonthKey();
      state.activities = state.activities.filter(a => monthKey(a.date) !== mk);
      save(); renderAll();
    });

    $('#exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'rpg-espanol-progress.json'; a.click(); URL.revokeObjectURL(url);
    });

    $('#importBtn').addEventListener('click', ()=> $('#fileInput').click());
    $('#fileInput').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(!data || !Array.isArray(data.activities)) throw new Error('JSON inválido');
          state.activities = data.activities;
          state.curriculum = data.curriculum || state.curriculum || buildCurriculumFrom(state.startDate || todayStr());
          state.sessions = data.sessions || state.sessions || {};
          state.startDate = data.startDate || state.startDate;
          save(); renderAll();
        }catch(err){ alert('Falha ao importar: '+err.message); }
      };
      reader.readAsText(f);
    });

    // Start date setter (guard if elements don't exist)
    const setStartBtn = document.querySelector('#setStartBtn');
    if(setStartBtn){
      setStartBtn.addEventListener('click', ()=>{
        const input = document.querySelector('#startDate');
        const d = input ? input.value : '';
        if(!d) return alert('Selecione uma data inicial.');
        state.startDate = d;
        state.curriculum = buildCurriculumFrom(d);
        save(); renderAll();
      });
    }

    // Atualizar app / limpar cache
    $('#refreshBtn').addEventListener('click', async (e)=>{
      e.preventDefault();
      const btn = e.target; const old = btn.textContent; btn.textContent = 'Limpando…'; btn.style.pointerEvents='none';
      try{
        // Limpa caches
        if('caches' in window){ const keys = await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }
        // Desregistra SWs
        if('serviceWorker' in navigator){ const regs = await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister())); }
      }catch(err){ console.warn('Falha ao limpar cache', err); }
      btn.textContent = 'Pronto! Recarregando…';
      setTimeout(()=> location.reload(true), 400);
    });

    // Modal controls (delegated to handle late DOM insertion)
    document.addEventListener('click', (e)=>{ if(e.target && e.target.id==='modalClose') closeModal(); });
    document.addEventListener('click', (e)=>{ if(e.target && e.target.id==='modal') closeModal(); });

    // Reset all progression (testing) with visual feedback
    const resetBtn = document.querySelector('#resetAllBtn');
    if(resetBtn){
      resetBtn.addEventListener('click', async ()=>{
        if(!confirm('Tem certeza? Isso apagará TODAS as atividades, sessões e currículo.')) return;
        const btn = resetBtn; const prev = btn.textContent;
        btn.disabled = true; btn.textContent = 'Resetando...'; btn.style.opacity = '0.7';
        try{
          // Limpa armazenamento do app
          try{ localStorage.clear(); }catch(_){ /* fallback */ localStorage.removeItem(STORAGE_KEY); }
          try{ sessionStorage.clear(); }catch(_){ /* ignore */ }

          // Limpa caches e desregistra service workers (feedback incremental)
          btn.textContent = 'Limpando cache...';
          if('caches' in window){ const keys = await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }
          btn.textContent = 'Desregistrando service worker...';
          if('serviceWorker' in navigator){ const regs = await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister())); }

          // Reconstrói estado inicial
          btn.textContent = 'Reiniciando dados...';
          state.activities = [];
          state.sessions = {};
          state.startDate = todayStr();
          state.curriculum = buildCurriculumFrom(state.startDate);
          // não persiste neste momento para garantir reset completo
          ensureStartElements();
          renderAll();

          btn.textContent = 'Reset concluído! Recarregando...';
          setTimeout(()=> location.reload(true), 600);
        }catch(err){
          console.error('Falha ao resetar', err);
          btn.textContent = 'Falha ao resetar';
          alert('Falha ao resetar: '+err.message);
          btn.disabled = false; btn.style.opacity = '';
          setTimeout(()=>{ btn.textContent = prev; }, 1500);
        }
      });
    } else {
      console.warn('Botão #resetAllBtn não encontrado para bind do reset.');
    }
  }

  function renderAll(){
    const mk = currentMonthKey();
    $('#monthLabel').textContent = 'Mês atual: '+mk;
    if(state.startDate){ $('#startLabel').textContent = 'Início: '+state.startDate; $('#startDate').value = state.startDate; }

    const actsMonth = state.activities.filter(a => monthKey(a.date) === mk).sort((a,b)=> a.date.localeCompare(b.date));
    renderTable(actsMonth);
    const xp = sumXP(actsMonth);
    const pct = Math.min(100, Math.round((xp/100)*100));
    $('#xpMonth').textContent = xp;
    $('#pctMonth').textContent = pct+'%';
    $('#barMonth').style.width = pct+'%';
    $('#barPct').textContent = pct+'%';

    const badges = MEDALS.filter(m => m.cond(actsMonth));
    $('#countBadges').textContent = badges.length;
    renderBadges(badges);

    $('#streakDay').textContent = dailyStreak(state.activities);

    renderWeeks(actsMonth);
    renderMissions();
    renderCurriculumCard();

    let levelName = 'Exploradora del idioma';
    if(xp>=25) levelName='Comunicadora en marcha';
    if(xp>=50) levelName='Oradora consistente';
    if(xp>=75) levelName='Profesional segura';
    if(xp>=100) levelName='Nativa honoraria';
    $('#levelLabel').textContent = 'Nível 1 — '+levelName;
  }

  function sumXP(list){ return list.reduce((a,b)=>a + (Number(b.xp)||0), 0); }

  function renderTable(list){
    const tbody = $('#tbody');
    tbody.innerHTML = '';
    if(list.length===0){
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="6" style="color:var(--muted)">Sem atividades registradas neste mês.</td>';
      tbody.appendChild(tr);
      return;
    }
    for(const a of list){
      const tr = document.createElement('tr');
      const t = TYPES[a.type] || {label:a.type, emoji:'✨'};
      tr.innerHTML = `
        <td>${a.date}</td>
        <td>${t.emoji} ${t.label}</td>
        <td><b>${a.xp}</b></td>
        <td>${a.minutes||''}</td>
        <td>${escapeHtml(a.notes||'')}</td>
        <td><button class="ghost" data-del="${a.id}">Excluir</button></td>
      `;
      tbody.appendChild(tr);
    }
    tbody.addEventListener('click', (e)=>{
      const id = e.target.getAttribute('data-del');
      if(!id) return;
      if(confirm('Excluir esta atividade?')){
        state.activities = state.activities.filter(x=>x.id!==id);
        save(); renderAll();
      }
    });
  }

  function renderBadges(badges){
    const wrap = $('#badges');
    wrap.innerHTML = '';
    if(badges.length===0){ wrap.innerHTML = '<div class="sub">Nenhuma medalha ainda — vamos conquistar a primeira esta semana! 💪</div>'; return; }
    for(const b of badges){
      const el = document.createElement('div');
      el.className = 'badge';
      el.innerHTML = `<div class="emoji">${b.emoji}</div>
                      <div>
                        <div class="name">${b.name}</div>
                        <div class="desc">${b.desc}</div>
                      </div>`;
      wrap.appendChild(el);
    }
  }

  function weekStreak(acts){
    if(acts.length===0) return false;
    const byWeek = new Map();
    for(const a of acts){
      const d = new Date(a.date);
      const wk = isoWeekKey(d);
      const set = byWeek.get(wk) || new Set();
      set.add(a.date);
      byWeek.set(wk, set);
    }
    for(const [wk,set] of byWeek){ if(set.size>=3) return true; }
    return false;
  }

  function renderWeeks(acts){
    const box = $('#weeks');
    box.innerHTML = '<h4 style="margin:14px 0 6px">Resumo semanal</h4>';
    const map = new Map();
    for(const a of acts){
      const wk = isoWeekKey(new Date(a.date));
      const arr = map.get(wk) || []; arr.push(a); map.set(wk, arr);
    }
    const entries = Array.from(map.entries()).sort(([a],[b])=>a.localeCompare(b));
    if(entries.length===0){ box.innerHTML += '<div class="sub">Semana ainda sem atividades.</div>'; return; }
    for(const [wk, list] of entries){
      const xp = sumXP(list);
      const pct = Math.min(100, Math.round((xp/100)*100));
      const div = document.createElement('div');
      div.className='week';
      div.innerHTML = `<div class="pill">Semana ${wk}</div><div class="bar"><span style="width:${pct}%"></span></div><div class="pill">${xp} XP</div>`;
      box.appendChild(div);
    }
  }

  function isoWeekKey(d){
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
    return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
  }

  /* function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  } */

  function escapeHtml(s){
    return String(s).replace(/[&<>\"']/g, function(m){
      return ({
        '&':'&amp;',
        '<':'&lt;',
        '>':'&gt;',
        '\"':'&quot;',
        "'":'&#39;'
      })[m];
    });
  }

  function dailyStreak(acts){
    if(!acts.length) return 0;
    const days = new Set(acts.map(a=>a.date).sort());
    let streak = 0;
    let d = new Date();
    for(;;){
      const ds = toDateStr(d);
      if(days.has(ds)){ streak++; d.setDate(d.getDate()-1); }
      else{ break; }
    }
    return streak;
  }

  // ---- Missions & Curriculum ----
  function buildCurriculumFrom(startStr){
    const start = new Date(startStr);
    const m0 = new Date(start.getFullYear(), start.getMonth(), 1);
    const m1 = new Date(start.getFullYear(), start.getMonth()+1, 1);
    const phases = [
      { key:keyOf(m0), title: monthTitle(m0) + ' — Semana(s) iniciais: fala + sotaque argentino', goals:['Onboarding','Shadowing curto','2 aulas/semana','Primeira conversa 5 min'], missions: genMonthPlan(m0.getFullYear(), m0.getMonth(), 'first', startStr) },
      { key:keyOf(m1), title: monthTitle(m1) + ' — Fluência guiada + reuniões', goals:['Reuniões simuladas','Vocabulário vivo','Apresentação pessoal','Pronúncia e ritmo'], missions: genMonthPlan(m1.getFullYear(), m1.getMonth(), 'second') },
    ];
    return { phases };
  }
  function monthTitle(d){
    const meses=['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    return meses[d.getMonth()]+' '+d.getFullYear();
  }
  function keyOf(d){ return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }

  function genMonthPlan(y,m,tag,startStr){
    const dates = daysOfMonth(y,m);
    const missions = [];
    let aulaCount = 0;
    const firstMonth = tag==='first';
    const lessonTitles = firstMonth ? [
      'Aula 0 — Bienvenida + diagnóstico de fala',
      'Aula 1 — 5 verbos essenciais + shadowing rioplatense',
      'Aula 2 — 5 verbos essenciais (2) + fala pessoal',
      'Aula 3 — Revisão 10 verbos + ritmo rioplatense',
      'Aula 4 — 5 verbos essenciais (3) + perguntas/respostas',
      'Aula 5 — 5 verbos essenciais (4) + mini apresentação',
      'Aula 6 — Simulação de reunião: status + blockers',
      'Aula 7 — Expressões argentinas de conversa',
      'Aula 8 — Conversa 5 min 100% ES + feedback'
    ] : [
      'Aula 1 — Reunião: dar opinião com cortes gentis',
      'Aula 2 — Concordar/discordar com exemplos do trabalho',
      'Aula 3 — Explicar tarefas e dependências',
      'Aula 4 — Pedir e dar feedback objetivo',
      'Aula 5 — Apresentação curta (2–3 min) com Q&A',
      'Aula 6 — Escalada de problemas (stakeholders)',
      'Aula 7 — Review de sprint em espanhol',
      'Aula 8 — Demo/retro simulada + feedback final'
    ];

    for(const d of dates){
      const dateStr = toDateStr(d);
      if(startStr && keyOf(d)===keyOf(new Date(startStr)) && dateStr < startStr) continue; // ignora dias antes do início
      const dow = d.getDay(); // 0 dom .. 6 sáb
      if(dow===1 || dow===3){
        const title = lessonTitles[aulaCount] || `Aula ${aulaCount+1} — prática de fala`;
        const xp = 15;
        missions.push({ id:uid(), date:dateStr, title, type:'speaking', xp, notes:'Sessão guiada (shadowing + fala ativa).', unlock:true, done:false });
        aulaCount++;
      }else if(dow===2){ missions.push({ id:uid(), date:dateStr, title:'Podcast 10–15min', type:'podcast', xp:5, notes:'Anotar 3 frases e repetir.', unlock:true, done:false }); }
      else if(dow===4){ missions.push({ id:uid(), date:dateStr, title:'Conjugação/Vocabulário', type:'vocab', xp:5, notes:'Bloco curto de revisão.', unlock:true, done:false }); }
      else if(dow===5){ missions.push({ id:uid(), date:dateStr, title:'Gravação + autoavaliação', type:'record', xp:10, notes:'Comparar com áudio original.', unlock:true, done:false }); }
      else if(dow===0){ missions.push({ id:uid(), date:dateStr, title:'Filme/Série ≥30min', type:'movie', xp:10, notes:'Áudio e legendas em espanhol.', unlock:true, done:false }); }
    }
    return missions;
  }

  function daysOfMonth(y,m){ const first = new Date(y,m,1); const dates=[]; let d=new Date(first); while(d.getMonth()===m){ dates.push(new Date(d)); d.setDate(d.getDate()+1);} return dates; }
  function toDateStr(d){ const z = new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
  function uid(){ return (crypto.randomUUID && crypto.randomUUID()) || ('id-'+Math.random().toString(36).slice(2)); }

  function renderMissions(){
    const today = todayStr();
    const mk = currentMonthKey();
    const ph = state.curriculum.phases.find(p=>p.key===mk);
    const todayBox = $('#todayMissions');
    const nextBox = $('#nextMissions');
    todayBox.innerHTML = ''; nextBox.innerHTML='';
    if(!ph){ todayBox.innerHTML='<div class="sub">Sem plano detalhado para este mês.</div>'; return; }

    const missions = ph.missions.sort((a,b)=> a.date.localeCompare(b.date));
    for(const ms of missions){ if(state.activities.some(a=> a.date===ms.date && a.type===ms.type && a.xp>=ms.xp)) ms.done=true; }

    const todays = missions.filter(ms => ms.date===today);
    const upcoming = missions.filter(ms => ms.date>today).slice(0,6);

    if(todays.length===0){ todayBox.innerHTML = '<div class="sub">Hoje não há missão programada. ✨'; }
    for(const ms of todays){ todayBox.appendChild(missionEl(ms,true,true)); }
    for(const ms of upcoming){ nextBox.appendChild(missionEl(ms,false,false)); }
  }

  function missionEl(ms,highlight,showStart){
    const div = document.createElement('div');
    div.className='mission';
    const t = TYPES[ms.type] || {emoji:'✨', label:'Missão'};
    const btn = ms.done? '<span class="pill">Concluída</span>' : (showStart? `<button class="primary" data-start="${ms.id}">Iniciar</button>` : '');
    div.innerHTML = `
      <div class="when"><span class="pill">${ms.date}</span></div>
      <div style="flex:1">
        <div class="title">${t.emoji} ${ms.title}</div>
        <div class="meta">${t.label} • ${ms.xp} XP</div>
        <div class="meta">${escapeHtml(ms.notes||'')}</div>
      </div>
      <div>${btn}</div>`;
    if(highlight) div.style.outline='2px solid rgba(96,165,250,.5)';

    div.addEventListener('click', (e)=>{
      const id = e.target.getAttribute('data-start');
      if(!id) return;
      openMission(ms);
    });
    return div;
  }

  function openMission(ms){
    const session = getOrCreateSession(ms);
    $('#modalTitle').textContent = `${TYPES[ms.type]?.emoji||'✨'} ${ms.title}`;
    // Render once and update in place on changes (avoids rebind storms)
    function renderSession(){
      const steps = session.steps;
      const pct = Math.round(100 * steps.filter(s=>s.done).length / steps.length);
      const list = steps.map((s,i)=>`<label style="display:flex; align-items:center; gap:10px; margin:8px 0">
          <input type="checkbox" data-step="${i}" ${s.done?'checked':''} />
          <span>${escapeHtml(s.label)}</span>
        </label>`).join('');
      const allDone = steps.every(s=>s.done);
      $('#modalBody').innerHTML = `
        <div class="progress" style="margin:6px 0 12px"><span style="width:${pct}%"></span><div class="pct">${pct}%</div></div>
        <div id="stepsWrap">${list}</div>
        <div class="row" style="margin-top:12px; justify-content:flex-end; gap:8px">
          <button class="ghost" id="saveSession">Salvar progresso</button>
          <button class="primary" id="finishMission" ${allDone? '' : 'disabled'}>Concluir missão (${ms.xp} XP)</button>
        </div>`;
      $('#stepsWrap').addEventListener('change', (e)=>{
        const idx = e.target.getAttribute('data-step');
        if(idx==null) return;
        session.steps[idx].done = e.target.checked;
        state.sessions[ms.id] = session; save();
        // just re-render inner body
        renderSession();
      });
      $('#saveSession').addEventListener('click', ()=>{ state.sessions[ms.id] = session; save(); closeModal(); });
      $('#finishMission').addEventListener('click', ()=>{ if(steps.every(s=>s.done)){ completeMission(ms.id); closeModal(); } });
    }
    renderSession();
    openModal();
  }

  function getOrCreateSession(ms){
    if(state.sessions[ms.id]) return state.sessions[ms.id];
    const steps = stepTemplate(ms.type);
    const s = { missionId: ms.id, date: ms.date, startedAt: Date.now(), steps, completed:false };
    state.sessions[ms.id] = s; save();
    return s;
  }

  function stepTemplate(type){
    switch(type){
      case 'speaking':
        return [
          {label:'Aquecimento: 5 verbos essenciais (voz alta, 3 tempos)', done:false},
          {label:'Shadowing 10 min (rioplatense)', done:false},
          {label:'Drills de perguntas/respostas (5 min)', done:false},
          {label:'Role-play de reunião (10 min)', done:false},
          {label:'Gravação 2–3 min + autoavaliação', done:false},
          {label:'Anotar 3 frases para usar amanhã', done:false},
        ];
      case 'podcast':
        return [
          {label:'Escolher episódio (10–15 min)', done:false},
          {label:'Ouvir sem pausar', done:false},
          {label:'Anotar 3 frases úteis', done:false},
          {label:'Repetir em voz alta', done:false},
        ];
      case 'vocab':
        return [
          {label:'Revisar 5 verbos (presente/passado/futuro)', done:false},
          {label:'Escrever 5 frases do trabalho', done:false},
          {label:'Mini quiz mental (active recall)', done:false},
        ];
      case 'record':
        return [
          {label:'Escolher texto/tema (1–2 min)', done:false},
          {label:'Gravar 1–2 min falando', done:false},
          {label:'Comparar com modelo nativo', done:false},
          {label:'Anotar 2 ajustes de pronúncia', done:false},
        ];
      case 'movie':
        return [
          {label:'Assistir 30 min (áudio + legendas ES)', done:false},
          {label:'Anotar 5 expressões novas', done:false},
          {label:'Repetir 5 frases com ritmo argentino', done:false},
        ];
      default:
        return [ {label:'Executar a missão', done:false} ];
    }
  }

  function missionById(id){
    const mk = currentMonthKey();
    const ph = state.curriculum.phases.find(p=>p.key===mk);
    if(!ph) return null;
    return ph.missions.find(x=>x.id===id) || null;
  }

  function completeMission(id){
    const mk = currentMonthKey();
    const ph = state.curriculum.phases.find(p=>p.key===mk);
    if(!ph) return;
    const ms = ph.missions.find(x=>x.id===id); if(!ms) return;
    if(ms.done) return;
    state.activities.push({ id: uid(), date: ms.date, type: ms.type, minutes: (ms.type==='speaking'?60:(ms.type==='podcast'?15:(ms.type==='movie'?30:0))), xp: ms.xp, notes: ms.title });
    ms.done = true;
    if(state.sessions[id]) state.sessions[id].completed = true;
    save(); renderAll();
  }

  function renderCurriculumCard(){
    const box = $('#curriculum'); box.innerHTML = '';
    for(const ph of state.curriculum.phases){
      const isCurrent = ph.key===currentMonthKey();
      const locked = !isCurrent && new Date(ph.key+'-01') > new Date();
      const div = document.createElement('div');
      div.className='mission';
      div.innerHTML = `<div class="when"><span class="pill">${ph.key}</span></div>
        <div style="flex:1">
          <div class="title">${locked?'🔒':'📖'} ${ph.title}</div>
          <div class="meta">Metas: ${ph.goals.join(' • ')}</div>
        </div>`;
      box.appendChild(div);
    }
  }

  function registerPWA(){
    if(!('serviceWorker' in navigator)) return;
    const swCode = `
      const CACHE = 'rpg-espanol-cache-v5';
      self.addEventListener('install', e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); self.skipWaiting(); });
      self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', e=>{ e.respondWith(
        caches.match(e.request).then(r => r || fetch(e.request).then(resp => {
          const copy = resp.clone(); caches.open(CACHE).then(c=>c.put(e.request, copy)); return resp;
        }).catch(()=> caches.match('./')))
      ); });`;
    const blob = new Blob([swCode], {type:'text/javascript'});
    navigator.serviceWorker.register(URL.createObjectURL(blob));

    let deferred; window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferred=e; $('#installBtn').style.display='inline'; });
    $('#installBtn').addEventListener('click', async (e)=>{ e.preventDefault(); if(deferred){ deferred.prompt(); deferred=null; }});
  }

  function openModal(){ const m=$('#modal'); m.style.display='flex'; m.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
  function closeModal(){ const m=$('#modal'); m.style.display='none'; m.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

  function startDateWatcher(){
    let last = todayStr();
    setInterval(()=>{ const now = todayStr(); if(now!==last){ last=now; renderAll(); } }, 60000);
  }

  // Seed example if empty
  if(!state.activities.length){
    const today = new Date();
    state.activities.push({ id: uid(), date: toDateStr(today), type:'movie', minutes:30, xp:10, notes:'Primeiro registro: filme em espanhol (30min).' });
    save();
  }
})();
</script>
  <div id="modal" aria-hidden="true" role="dialog" aria-modal="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(3,6,23,.6); backdrop-filter: blur(4px); z-index:9999">
    <div class="card modal-card" style="width:min(780px, 94vw); max-height:88vh; overflow:auto; box-shadow:0 24px 80px rgba(0,0,0,.7); padding:16px">
      <div class="row" style="justify-content:space-between; align-items:center; position:sticky; top:0; background:linear-gradient(180deg, rgba(16,27,52,1), rgba(16,27,52,.96)); padding-bottom:8px; z-index:1">
        <h3 id="modalTitle" style="margin:0">Missão</h3>
        <button class="ghost close-btn" id="modalClose" aria-label="Fechar" title="Fechar">×</button>
      </div>
      <div id="modalBody" style="margin-top:8px"></div>
    </div>
  </div>
</body>
</html>
